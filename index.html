<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title>Direct Match History</title>
  <link rel="stylesheet" href="index.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>

<body>
  <div class="logo-and-text" style="display: flex;justify-content: left;align-items: center;">
    <img class="logo" src="GUSlogo.png" alt="GUStakes Logo">  
    <p>GUSLabs</p>
  </div>

  <div class="logo-and-text2" style="text-align: center;">
    <img class="gu-logo" src="GU logo2.png" alt="GU Logo">


  <div class="topbar">
    <h1 style="margin-top: 0px; text-align: center;">Direct Match History</h1>
  </div>
</div>

  <div class="topbar2">
    <p class="topbar2-text">Enter your Gods Unchained Player ID below and select a date within the last three days for your recent match.</p>
  </div>

  <div class="topbar-input" id="container">
    <div class="input-fields">
      <input type="text" id="textbox" placeholder="GU Player ID" list="playerids">
      <input type="hidden" name="ids" id="playerids-hidden">
      <input type="hidden" id="timestamp" placeholder="Select a date" data-input="" class="flatpickr-input">
    </div>
    <div class="button-fields">   
      <button id="submit">Submit</button>
      <button id="reset">Reset</button>
    </div>
  </div>

  <div id="output" placeholder="enter player id"></div>

  <video id="background-video" autoplay loop muted poster="">
    <source src="GUSVideoBG.mp4" type="video/mp4">
  </video>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      try {
        flatpickr("#timestamp", {
          enableTime: false,
          altInput: true,
          altFormat: "F j, Y",
          dateFormat: "U",
          onChange: function (selectedDates, dateStr, instance) {
            const timestampHiddenElement = document.getElementById("timestamp-hidden");
            if (timestampHiddenElement) {
              const unixTimestamp = dateStr;
              timestampHiddenElement.value = unixTimestamp;
            }
          }
        });
      } catch (error) {
        console.error("An error occurred:", error);
        alert("An error occurred. Please check the console for details.");
      }
    });
  </script>

  <script>
    $(document).ready(function () {
      const input = $('#textbox');
      const button = $('#submit');
      const timeStamp = $('#timestamp');
      const output = $('#output');

      function toggleSubmitButton() {
        const playerId = input.val();
        const dateSelected = timeStamp.val();
        button.prop('disabled', !(playerId && dateSelected));
      }

      function highlightInputBox() {
        const originalColor = input.css('background-color');
        input.css('background-color', 'white');
        input.animate({ 'background-color': originalColor }, 2000);
      }

      function displayErrorMessage(message) {
        output.empty();
        const errorMessage = $(`<p class="error-message" style="color: red;">${message}</p>`);
        output.append(errorMessage);
        const originalColor = input.css('background-color');
        input.css('background-color', 'red');
        input.animate({ 'background-color': originalColor }, 2000);
        setTimeout(() => {
          errorMessage.fadeOut(2000, function () {
            errorMessage.remove();
            input.css('background-color', originalColor);
          });
        }, 4000);
      }

      input.on('input', function () {
        toggleSubmitButton();
        input.css('background-color', 'white');
      });

      timeStamp.on('change', toggleSubmitButton);

      $('#submit').click(function () {
        try {
          const playerid = input.val();
          const time = timeStamp.val();

          if (!playerid.trim()) {
            displayErrorMessage("Please input your Gods Unchained Player ID");
            highlightInputBox();
            return;
          }

          const invalidInput = /\D/.test(playerid);
          if (invalidInput) {
            displayErrorMessage("Your Player ID must only contain numbers");
            highlightInputBox();
            return;
          }

          const myCards = [];
          const matches = [];
          let wonRecords;
          let lostRecords;
          let username;

          $.get(`https://api.godsunchained.com/v0/properties?user_id=${playerid}`, (d) => {
            const dat = JSON.parse(d);

            const recs = dat.records;
            const user = recs[0];

            username = user.username;

            $.get(`https://api.godsunchained.com/v0/match?start_time=${time}-&player_won=${playerid}`, (data) => {
              const obj = JSON.parse(data);
              wonRecords = obj.records && obj.records.filter((x) => x.game_mode === 6) || null;
              matches.push(wonRecords);
              $.get(`https://api.godsunchained.com/v0/match?start_time=${time}-&player_lost=${playerid}`, (data) => {
                const obj = JSON.parse(data);
                lostRecords = obj.records && obj.records.filter((x) => x.game_mode === 6) || null;
                matches.push(lostRecords);

                const flattened = matches.flat();
                const filtered = flattened.filter((x) => x !== null);

                if (output.children().length === 0) {
                  const resultDiv = $('<div class="playercard">');

                  resultDiv.append(`<h2 style="font-size: 28px">${username}</h2>`);
                  resultDiv.append(`<p>${wonRecords && wonRecords.length || 0} W&nbsp;&nbsp;-&nbsp;&nbsp;${lostRecords && lostRecords.length || 0} L</p>`);
                  output.append(resultDiv);

                  // Shrink the gu-logo down
                  $('.logo-and-text2').css('transition', 'calc(1s)');
                  $('.logo-and-text2').css('transform', 'scale(0.5)');
                  $('.logo-and-text2').css('margin','-60px 0 -40px 0');

                  filtered.map((x) => {
                    const {
                      player_won,
                      player_lost
                    } = x;
                    const participants = [player_won, player_lost];
                    console.log(participants);
                    const opponentid = participants.find((x) => x !== parseInt(playerid));
                    const matchId = x.game_id; // Save the match ID
                    const containerId = `${matchId}-container`;

                    output.append(`
                      <div id='${containerId}'>
                        <button style="min-width: 40%; margin: 10px auto;" class='action-button' data-match-id="${matchId}">${username} vs. ${opponentid}</button>
                      </div>
                    `);

                    // Add the click event outside the map function
                    $(`#${containerId}`).on('click', '.action-button', async (e) => {
                      const id = $(e.target).data('match-id');
                      const targetMatchArr = filtered.filter(x => x.game_id === id);
                      const targetMatch = targetMatchArr[0];
                      const {
                        player_won,
                        player_info
                      } = targetMatch;
                      const outcome = parseInt(player_won) === parseInt(playerid) ? 'Won' : 'Lost';
                      const opponentOutcome = parseInt(player_won) !== parseInt(playerid) ? 'Won' : 'Lost';

                      const userInfo = player_info.find((x) => x.user_id === parseInt(playerid));
                      const opponentInfo = player_info.find((x) => x.user_id !== parseInt(playerid));
                      const {
                        cards: userCards,
                        god: userGod
                      } = userInfo;
                      const {
                        cards: opponentCards,
                        user_id: opponentPlayerid,
                        god: opponentGod
                      } = opponentInfo;
                      console.log(id);

                      const container = `
                        <div id="${id}" class="versus-container">
                          <div class="versus-buttons">
                            <button class="close-button" id="${id}-${playerid}-close">Close</button>
                          </div>
                          <div class="player-container">
                            <div class="user-container">
                              <div><h2 style="text-transform: capitalize; background-color: #00000070; padding: 11px 40px; border: none; border-radius: 5px;"><a style="text-decoration: underline;" target=_blank href=https://gudecks.com/meta/player-stats?userId=${playerid}>${username}</a>&nbsp;&nbsp;-&nbsp;&nbsp;${outcome} (${userGod})</h2></div>
                              <div class="container"></div>
                              <div class="image-container"></div>
                            </div>
                            <div class="opponent-container">
                              <div class="container">
                                <a style="text-decoration: underline" target=_blank href=https://gudecks.com/meta/player-stats?userId=${opponentPlayerid}><h2 style="text-transform: capitalize; background-color: #00000070; padding: 11px 40px; border: none; border-radius: 5px;">${opponentPlayerid}</a>&nbsp;&nbsp;-&nbsp;&nbsp;${opponentOutcome} (${opponentGod})</h2></a>
                              </div>
                              <div class="image-container"></div>
                            </div>
                          </div>
                        </div>
                      `;

                      if ($(`#${id}-container`).children().length === 1) {
                        $(`#${id}-container`).append(container);

                        // Show the "Close" button after clicking "See Match Details"
                        $(`#${id}-${playerid}-close`).show();
                      }

                      console.log($(`#${id}-container`).children());

                      const showCards = (cards, target) => {
                        const myCards = [];
                        $.get("https://api.godsunchained.com/v0/proto?perPage=3000", function (data) {
                          const cardData = JSON.parse(data);
                          const allCards = cardData.records;
                          cards.map((x) => {
                            const card = allCards.filter((y) => y.id === parseInt(x));
                            const targetcard = card[0];
                            const cardId = targetcard.id;
                            const result = {
                              ...targetcard,
                              image: `https://card.godsunchained.com/?id=${cardId}&q=4`
                            };
                            myCards.push(result);
                          });
                          const sorted = myCards.sort((a, b) => {
                            return a.mana - b.mana;
                          });

                          console.log(sorted);
                          sorted.map((x) => {
                            if ($(`#${id}-container`).find(target).find(".image-container").children().length <= sorted.length - 1) {
                              $(`#${id}-container`).find(target).find(".image-container").append(`<img class="card-image" src=${x.image}/>`);
                            }
                          });
                        });
                      };

                      showCards(userCards, '.user-container');
                      showCards(opponentCards, '.opponent-container');
                    });

                    $(`#${containerId}`).on('click', '.close-button', function (event) {
                      console.log("Close button clicked!");

                      // Get the ID of the clicked close button
                      const closeBtnId = event.currentTarget.id;
                      const id = closeBtnId.split("-");
                      id.pop();
                      id.pop();
                      const matchId = id.join("-");
                      console.log(matchId);

                      // Your existing logic for handling close button click goes here
                      const container = $(`#${matchId}`);
                      container.remove();
                    });
                  });
                }
              });
            });
          });
        } catch (error) {
          console.error("An error occurred:", error);
          alert("An error occurred. Please check the console for details.");
        }
      });

      $('#reset').click(function () {
        $('.logo-and-text2').css('margin','20px 0 2px 0px');
        $('.logo-and-text2').css('transform', 'scale(1)');
        output.html('');
        input.val('');
        button.prop('disabled', true);
        $('#timestamp').val('');

        // Destroy the existing Flatpickr instance
        const flatpickrInstance = flatpickr("#timestamp");
        flatpickrInstance.destroy();

        // Reinitialize Flatpickr
        initializeFlatpickr();
      });

      // Function to initialize Flatpickr
      function initializeFlatpickr() {
        try {
          flatpickr("#timestamp", {
            enableTime: false,
            altInput: true,
            altFormat: "F j, Y",
            dateFormat: "U",
            onChange: function (selectedDates, dateStr, instance) {
              const timestampHiddenElement = document.getElementById("timestamp-hidden");
              if (timestampHiddenElement) {
                const unixTimestamp = dateStr;
                timestampHiddenElement.value = unixTimestamp;
              }
            }
          });
        } catch (error) {
          console.error("An error occurred:", error);
          alert("An error occurred. Please check the console for details.");
        }
      }

      // Initialize Flatpickr on document load
      document.addEventListener("DOMContentLoaded", function () {
        initializeFlatpickr();
      });
    });
  </script>

  <script>
    let vid = document.getElementById("background-video");
    vid.playbackRate = 0.6;
  </script>

</body>

</html>