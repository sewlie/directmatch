<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title>
    GUStakes Match History
  </title>
  <link rel="stylesheet" href="index.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>

<body>
  <img class="logo" src="https://images.squarespace-cdn.com/content/6395478721d02d2b94b64324/0d58d7db-04dd-447d-b5da-a72ca6e63f96/gustakes+logo+high+res.png?content-type=image%2Fpng" alt="GUStakes Logo">
  <br><h1>GUStakes Match History</h1>
  <div id="container">
    <input type="text" id="textbox" placeholder="Enter playerid" list="playerids">
    <input type="hidden" name="ids" id="playerids-hidden">
    </input>
    <input type="text" id="timestamp" placeholder="Select a date" data-input>
    <input type="hidden" name="time" id="timestamp-hidden">
    <input type="hidden" name="time" id="timestamp-hidden">
    <button id="submit">
      submit
    </button>
  </div>
  <div id="output" placeholder="enter player id">
  </div>

  <video id="background-video" autoplay loop muted poster="">
    <source src="GUSVideoBG.mp4" type="video/mp4">
</video>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
  integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
  crossorigin="anonymous" referrerpolicy="no-referrer">
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    flatpickr("#timestamp", {
      enableTime: false,
      altInput: true,
      altFormat: "F j, Y",
      dateFormat: "U",
      onChange: function (selectedDates, dateStr, instance) {
        const unixTimestamp = dateStr;
        document.getElementById("timestamp-hidden").value = unixTimestamp;
      }
    });
  });
</script>

<script>
  $(document).ready(function () {
    const container = $('#container');
    const input = $('#textbox');
    const button = $('#submit');
    const output = $('#output');
    const timeStamp = $('#timestamp');

    button.click(function myFunc() {
      // Existing code ...

      // Reset output when date changes
      $('#timestamp').on('change', function () {
        output.html('');
      });

      // Existing code ...
    });
  });
</script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
    integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer">
    </script>
  <!---<script type="text/javascript" src="index.js">
  </script>--->
  <script>
  $(document).ready(function () {
    const container = $('#container');
    const input = $('#textbox');
    const button = $('#submit');
    const output = $('#output');
    const timeStamp = $('#timestamp');
  
    button.click(function myFunc() {
      const myCards = [];
      const playerid = input.val();
      const time = timeStamp.val();
      const matches = [];
      let wonRecords;
      let lostRecords;
      let username;
  
      $.get(`https://api.godsunchained.com/v0/properties?user_id=${playerid}`, (d) => {
        const dat = JSON.parse(d);
  
        const recs = dat.records;
        const user = recs[0];
  
        username = user.username;
  
        $.get(`https://api.godsunchained.com/v0/match?start_time=${time}-&player_won=${playerid}`, (data) => {
          const obj = JSON.parse(data);
          wonRecords = obj.records && obj.records.filter((x) => x.game_mode === 6) || null;
          matches.push(wonRecords);
          $.get(`https://api.godsunchained.com/v0/match?start_time=${time}-&player_lost=${playerid}`, (data) => {
            const obj = JSON.parse(data);
            lostRecords = obj.records && obj.records.filter((x) => x.game_mode === 6) || null;
            matches.push(lostRecords);
  
            const flattened = matches.flat()
            const filtered = flattened.filter((x) => x !== null);
  
            if (output.children().length === 0) { 
              output.append(`<p>${username}</p><br>`)
              output.append(`<p>Total Matches: ${filtered.length}</p>`)
              output.append(`<p>Won Matches: ${wonRecords && wonRecords.length || 0}</p>`);
              output.append(`<p>Lost Matches: ${lostRecords && lostRecords.length || 0}</p><br>`);  
              filtered.map((x) => {
                const { 
                  player_won,
                  player_lost
                } = x;
                const participants = [player_won, player_lost];
                console.log(participants)
                const opponentid = participants.find((x) => x !== parseInt(playerid));
                output.append(`
                  <div id='${x.game_id}-container'>
                    <button class='action-button' id=${x.game_id}>See Match Details of match against ${opponentid}</button>
                  </div>
                `)
              });
            }
            $('.action-button').click(async (e) => {
  
              const id = e.target.id;
              const targetMatchArr = filtered.filter(x => x.game_id === id);
              const targetMatch = targetMatchArr[0];
              const { player_won, player_info } = targetMatch;
              const outcome = parseInt(player_won) === parseInt(playerid) ? 'Won' : 'Lost';
              const opponentOutcome = parseInt(player_won) !== parseInt(playerid) ? 'Won' : 'Lost';
  
              const userInfo = player_info.find((x) => x.user_id === parseInt(playerid));
              const opponentInfo = player_info.find((x) => x.user_id !== parseInt(playerid));
  
              const { cards: userCards, god: userGod,  } = userInfo;
              const { cards: opponentCards, user_id: opponentPlayerid, god: opponentGod } = opponentInfo;
  
              const container = `
                <div class="versus-container">
                  <div class="user-container">
                    <div><br>${username}</div>
                    <div class="container">
                      <span>
                      Result: ${outcome}
                      </span>
                      <span>
                        God used: ${userGod}
                      </span>
                      <button id="${id}-${playerid}-deck">v   See Deck   v</button>
                    </div>
                    <div class="image-container">
                    </div>
                  </div>
                  <div class="opponent-container">
                    <div class="container">
                      <span>
                      ${opponentPlayerid}<br/>
                      </span>
                      <a target=_blank href=https://gudecks.com/meta/player-stats?userId=${opponentPlayerid}>
                      Opponent GUDecks Link
                      </a>
                      <span>
                      opponent ${opponentOutcome}
                      </span>
                      <span>
                        God used: ${opponentGod}
                      </span>
                      <button id="${id}-opponent-deck">v   See Deck   v</button>
                    </div>
                    <div class="image-container">
                    </div>
                  </div>  
                </div>
              `;
  
              console.log($(`#${id}-container`).children())
  
              if ($(`#${id}-container`).children().length === 1) { 
                $(`#${id}-container`).append(container);
              }
              const showCards = (cards, target) => {
  
                const myCards = [];
                $.get("https://api.godsunchained.com/v0/proto?perPage=3000", function (data) {
                  const cardData = JSON.parse(data);
                  const allCards = cardData.records;
                  cards.map((x) => {
                    const card = allCards.filter((y) => y.id === parseInt(x));
                    const targetcard = card[0];
                    const cardId = targetcard.id;
                    const result = {
                      ...targetcard,
                      image: `https://card.godsunchained.com/?id=${cardId}&q=4`
                    }
                    myCards.push(result);
                  });
                  const sorted = myCards.sort((a, b) => {
                    return a.mana - b.mana;
                  });
  
                  console.log(sorted);
                  sorted.map((x) => {
                    if ($(`#${id}-container`).find(target).find(".image-container").children().length <= sorted.length - 1) { 
                      $(`#${id}-container`).find(target).find(".image-container").append(`<img class="card-image" src=${x.image}/>`)
                    }
                  });
                });
              }
  
              $(`#${id}-${playerid}-deck`).click(() => {
                showCards(userCards, '.user-container'),
                showCards(opponentCards, '.opponent-container');
              });
  
            });
  
          });
        });
      })
  
  
  
  
  
  
  
  
    });
  });
  </script>
  <script>
    let vid = document.getElementById("background-video");
    vid.playbackRate = 0.4;
</script>

</body>

</html>