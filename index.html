<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title>
    Direct Match History
  </title>
  <link rel="stylesheet" href="index.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>

<body>
  <div class="logo-and-text" style="display: flex; justify-content: cemter; align-items: center;">
    <img class="logo" src="https://images.squarespace-cdn.com/content/6395478721d02d2b94b64324/0d58d7db-04dd-447d-b5da-a72ca6e63f96/gustakes+logo+high+res.png?content-type=image%2Fpng" alt="GUStakes Logo">  
    <p>GUSLabs
    </p>
</div>

  <div class="logo-and-text2" style="text-align: center;">
    <img class="gu-logo" src="GU logo2.png" alt="GU Logo">
    <!---<h1 style="margin-top: 10px; text-align: center;">GODS UNCHAINED</h1>---> 
  </div> 
  <div class="topbar">
    <h1 style="margin-top: 0px; text-align: center;">Direct Match History</h1>
  </div>
  <div class="topbar2">
    <p class="topbar2-text">Paste your Gods Unchained Player ID below and choose a date that is within 3 days of your direct match</p>
  </div>
  <div class="topbar-input" id="container">

        <input type="text" id="textbox" placeholder="GU Player ID" list="playerids">
        <input type="hidden" name="ids" id="playerids-hidden">
        
        <input type="hidden" id="timestamp" placeholder="Select a date" data-input="" class="flatpickr-input" value="1701406800">
        <div class="input-fields">
        <button id="submit">
            submit
        </button>
    </div>
</div>


  <div id="output" placeholder="enter player id">
  </div>

  <video id="background-video" autoplay loop muted poster="">
    <source src="GUSVideoBG.mp4" type="video/mp4">
</video>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
  integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
  crossorigin="anonymous" referrerpolicy="no-referrer">
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    try {
        flatpickr("#timestamp", {
            enableTime: false,
            altInput: true,
            altFormat: "F j, Y",
            dateFormat: "U",
            onChange: function (selectedDates, dateStr, instance) {
                // Check if the element exists before trying to access it
                const timestampHiddenElement = document.getElementById("timestamp-hidden");

                if (timestampHiddenElement) {
                    // Set the value only if the element exists
                    const unixTimestamp = dateStr;
                    timestampHiddenElement.value = unixTimestamp;
                }
            }
        });
    } catch (error) {
        // Display an error message on the screen
        console.error("An error occurred:", error);
        // You can modify the following line to display the error message on the screen
        alert("An error occurred. Please check the console for details.");
    }
});
</script>

<script>
$(document).ready(function () {
    const input = $('#textbox');
    const button = $('#submit');
    const timeStamp = $('#timestamp');
    const output = $('#output');

    // Function to enable or disable the submit button based on input values
    function toggleSubmitButton() {
        const playerId = input.val();
        const dateSelected = timeStamp.val();

        // Enable the button if both player ID and date are provided
        button.prop('disabled', !(playerId && dateSelected));
    }

    // Function to highlight the GU Player ID input box in red and fade back to white
    function highlightInputBox() {
        // Save the original background color
        const originalColor = input.css('background-color');

        // Change the background color to red
        input.css('background-color', 'white');

        // Animate the transition back to the original color over 1 second
        input.animate({ 'background-color': originalColor }, 2000);
    }

// Function to display an error message
function displayErrorMessage(message) {
    // Clear any existing output
    output.empty();

    // Display the error message
    const errorMessage = $(`<p class="error-message" style="color: red;">${message}</p>`);
    output.append(errorMessage);

    // Save the original background color
    const originalColor = input.css('background-color');

    // Change the background color to red
    input.css('background-color', 'red');

    // Animate the transition back to the original color over 1 second
    input.animate({ 'background-color': originalColor }, 2000);

    // Remove the error message after fading out
    setTimeout(() => {
        errorMessage.fadeOut(2000, function () {
            errorMessage.remove();
            input.css('background-color', originalColor); // Reset the input box color
        });
    }, 4000);
}

    // Add input event listener to the player ID input
    input.on('input', function () {
        toggleSubmitButton();

        // Reset the input box color when the user starts typing again
        input.css('background-color', 'white');
    });

    // Add change event listener to the date picker
    timeStamp.on('change', toggleSubmitButton);

    button.click(function myFunc() {
        try {
            const playerid = input.val();
            const time = timeStamp.val();

            // Check if GU player ID is empty
            if (!playerid.trim()) {
                // Display an error message on the screen
                displayErrorMessage("Please input your Gods Unchained Player ID");
                // Highlight the input box in red
                highlightInputBox();
                return; // Exit the function to prevent further execution
            }

            // Check if input contains anything other than numbers
            const invalidInput = /\D/.test(playerid);
            if (invalidInput) {
                // Display an error message
                displayErrorMessage("Your Player ID must only contain numbers");
                // Highlight the input box in red
                highlightInputBox();
                return; // Exit the function to prevent further execution
            }

            const myCards = [];
            const matches = [];
            let wonRecords;
            let lostRecords;
            let username;

            // API call to retrieve user properties
            $.get(`https://api.godsunchained.com/v0/properties?user_id=${playerid}`, (d) => {
                // Existing code...
            });
        } catch (error) {
            // Display an error message on the screen
            console.error("An error occurred:", error);
            // You can modify the following line to display the error message on the screen
            alert("An error occurred. Please check the console for details.");
        }
    });
});
</script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
    integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer">
    </script>
  <!---<script type="text/javascript" src="index.js">
  </script>--->
  <script>
  $(document).ready(function () {
    const container = $('#container');
    const input = $('#textbox');
    const button = $('#submit');
    const output = $('#output');
    const timeStamp = $('#timestamp');
  
    button.click(function myFunc() {
      const myCards = [];
      const playerid = input.val();
      const time = timeStamp.val();
      const matches = [];
      let wonRecords;
      let lostRecords;
      let username;

      // Reset output when date changes
      $('#timestamp').on('change', function () {
        output.html('');
      });

      $('#textbox').on('change', function () {
        output.html('');
      });
  
      $.get(`https://api.godsunchained.com/v0/properties?user_id=${playerid}`, (d) => {
        const dat = JSON.parse(d);
  
        const recs = dat.records;
        const user = recs[0];
  
        username = user.username;
  
        $.get(`https://api.godsunchained.com/v0/match?start_time=${time}-&player_won=${playerid}`, (data) => {
          const obj = JSON.parse(data);
          wonRecords = obj.records && obj.records.filter((x) => x.game_mode === 6) || null;
          matches.push(wonRecords);
          $.get(`https://api.godsunchained.com/v0/match?start_time=${time}-&player_lost=${playerid}`, (data) => {
            const obj = JSON.parse(data);
            lostRecords = obj.records && obj.records.filter((x) => x.game_mode === 6) || null;
            matches.push(lostRecords);
  
            const flattened = matches.flat()
            const filtered = flattened.filter((x) => x !== null);
  
            if (output.children().length === 0) { 
              output.append(`<p>Name:</p><h2>${username}</h2>`)
              output.append(`<p>Record:</p><br><p>Total Matches: ${filtered.length}</p>`)
              output.append(`<p>Won Matches: ${wonRecords && wonRecords.length || 0}</p>`);
              output.append(`<p>Lost Matches: ${lostRecords && lostRecords.length || 0}</p><br>`);  
              filtered.map((x) => {
                const { 
                  player_won,
                  player_lost
                } = x;
                const participants = [player_won, player_lost];
                console.log(participants)
                const opponentid = participants.find((x) => x !== parseInt(playerid));
                output.append(`
                  <div id='${x.game_id}-container'>
                    <button class='action-button' id=${x.game_id}>See Match Details of match against ${opponentid}</button>
                  </div>
                `)
              });
            }
            $('.action-button').click(async (e) => {
  
              const id = e.target.id;
              const targetMatchArr = filtered.filter(x => x.game_id === id);
              const targetMatch = targetMatchArr[0];
              const { player_won, player_info } = targetMatch;
              const outcome = parseInt(player_won) === parseInt(playerid) ? 'Won' : 'Lost';
              const opponentOutcome = parseInt(player_won) !== parseInt(playerid) ? 'Won' : 'Lost';
  
              const userInfo = player_info.find((x) => x.user_id === parseInt(playerid));
              const opponentInfo = player_info.find((x) => x.user_id !== parseInt(playerid));
  
              const { cards: userCards, god: userGod,  } = userInfo;
              const { cards: opponentCards, user_id: opponentPlayerid, god: opponentGod } = opponentInfo;
  
              const container = `
                <div class="versus-container">
                  <div class="user-container">
                    <div><br>${username}</div>
                    <div class="container">
                      <span>
                      Result: ${outcome}
                      </span>
                      <span>
                        God used: ${userGod}
                      </span>
                      <button id="${id}-${playerid}-deck">v   See Deck   v</button>
                    </div>
                    <div class="image-container">
                    </div>
                  </div>
                  <div class="opponent-container">
                    <div class="container">
                      <span>
                      ${opponentPlayerid}<br/>
                      </span>
                      <a target=_blank href=https://gudecks.com/meta/player-stats?userId=${opponentPlayerid}>
                      Opponent GUDecks Link
                      </a>
                      <span>
                      opponent ${opponentOutcome}
                      </span>
                      <span>
                        God used: ${opponentGod}
                      </span>
                      <button id="${id}-opponent-deck">v   See Deck   v</button>
                    </div>
                    <div class="image-container">
                    </div>
                  </div>  
                </div>
              `;
  
              console.log($(`#${id}-container`).children())
  
              if ($(`#${id}-container`).children().length === 1) { 
                $(`#${id}-container`).append(container);
              }
              const showCards = (cards, target) => {
  
                const myCards = [];
                $.get("https://api.godsunchained.com/v0/proto?perPage=3000", function (data) {
                  const cardData = JSON.parse(data);
                  const allCards = cardData.records;
                  cards.map((x) => {
                    const card = allCards.filter((y) => y.id === parseInt(x));
                    const targetcard = card[0];
                    const cardId = targetcard.id;
                    const result = {
                      ...targetcard,
                      image: `https://card.godsunchained.com/?id=${cardId}&q=4`
                    }
                    myCards.push(result);
                  });
                  const sorted = myCards.sort((a, b) => {
                    return a.mana - b.mana;
                  });
  
                  console.log(sorted);
                  sorted.map((x) => {
                    if ($(`#${id}-container`).find(target).find(".image-container").children().length <= sorted.length - 1) { 
                      $(`#${id}-container`).find(target).find(".image-container").append(`<img class="card-image" src=${x.image}/>`)
                    }
                  });
                });
              }
  
              $(`#${id}-${playerid}-deck`).click(() => {
                showCards(userCards, '.user-container'),
                showCards(opponentCards, '.opponent-container');
              });
  
            });
  
          });
        });
      })
  
  
  
  
  
  
  
  
    });
  });
  </script>
  <script>
    let vid = document.getElementById("background-video");
    vid.playbackRate = 0.4;
</script>

</body>

</html>